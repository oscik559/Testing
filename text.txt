1. **Context Loss**: Regex patterns like `\.add_new_(\w+)\(` extracted only `direction` from `hybrid_shape_factory.add_new_direction()`, losing the crucial `hybrid_shape_factory` context
2. **Poor Matching**: Database searches used generic method names without considering the object/class context
3. **Ambiguous Results**: First match selection from multiple database instances without context validation


### Key Improvements

#### 1. **AST-Based Context Preservation**
```python
# OLD: Regex extraction (loses context)
r"\.add_new_(\w+)\("  # Extracts: "direction"

# NEW: AST analysis (preserves full context)
MethodCall(
    object_chain="hybrid_shape_factory",
    method_name="add_new_direction_by_coord", 
    full_call="hybrid_shape_factory.add_new_direction_by_coord"
)


### 2. **Smart Database Matching**
```python
# OLD: Generic search
cursor.execute("SELECT * FROM pycatia_methods WHERE method_name LIKE ?", (f"%{method_name}%",))

# NEW: Context-aware hierarchical matching
signatures = [
    "hybrid_shape_factory.add_new_direction_by_coord",  # Most specific
    "add_new_direction_by_coord"                        # Fallback
]
# Prefers matches with correct class context (HybridShapeFactory)
```


#### 3. **Enhanced Database Schema**
```sql
-- NEW: Rich context preservation
CREATE TABLE final_steps_methods (
    step_number INTEGER,
    function_name TEXT,
    object_chain TEXT,           -- "hybrid_shape_factory"
    method_name TEXT,            -- "add_new_direction_by_coord"  
    full_call TEXT,              -- "hybrid_shape_factory.add_new_direction_by_coord"
    line_number INTEGER,         -- Code location
    matched_full_signature TEXT, -- Database match result
    -- ...
)
```

We need smart contextual matching that considers:

Variable chain context: geom_set = hybrid_bodies.add()
Return type mapping: HybridBodies.add() returns HybridBody
Prioritized search: Look for HybridBody.append_hybrid_shape specifically


The enhanced return type tracking completes the AST-based context preservation by following the entire object lifecycle through method calls, eliminating the last remaining context gaps in your PyCATIA method extraction system.